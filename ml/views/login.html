<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - API Mercado Livre</title>

  <!-- mantém como está (se teu root também serve /css ok). Se quiser 100% isolado do /ml, eu te passo a versão com prefixo também -->
  <link rel="stylesheet" href="/css/login.css" />
</head>

<body>
  <div class="login-container">
    <h1>MERCADO LIVRE</h1>

    <p id="errorMessage" class="error-message" style="display: none;"></p>

    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="senha" placeholder="Senha" required />
      <button type="submit">Entrar</button>
    </form>

    <p>Não tem conta? <a href="#" id="linkCadastro">Cadastre-se</a></p>
  </div>

  <script>
    // ✅ Base helper: funciona em / (standalone) e em /ml (suite)
    function detectMlBase() {
      const p = String(location.pathname || "/");
      const i = p.indexOf("/ml/");
      if (i >= 0) return p.slice(0, i + 3); // suporta também /alguma-coisa/ml/...
      if (p === "/ml") return "/ml";
      return "";
    }

    function U(path) {
      if (typeof window.mlUrl === "function") return window.mlUrl(path); // se existir
      const base = detectMlBase();
      if (!path) return base || "/";
      if (/^https?:\/\//i.test(path)) return path;
      const p = path.startsWith("/") ? path : `/${path}`;
      if (!base) return p;
      if (p === base || p.startsWith(base + "/")) return p;
      return base + p;
    }

    // ✅ Corrige link de cadastro
    document.getElementById("linkCadastro")?.addEventListener("click", (e) => {
      e.preventDefault();
      location.href = U("/cadastro");
    });

    document.getElementById("loginForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const errorMessage = document.getElementById("errorMessage");
      errorMessage.style.display = "none";
      errorMessage.textContent = "";

      const email = document.getElementById("email").value.trim();
      const senha = document.getElementById("senha").value;

      try {
        const response = await fetch(U("/api/auth/login"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ email, senha }),
        });

        const data = await response.json().catch(() => null);

        if (!response.ok || !data?.ok) {
          const msg = data?.error || "Credenciais inválidas.";
          errorMessage.textContent = msg;
          errorMessage.style.display = "block";
          return;
        }

        // ✅ depois do login, vai pra seleção de conta dentro do /ml se for o caso
        location.href = U("/select-conta");
      } catch (err) {
        errorMessage.textContent = "Erro ao conectar no servidor.";
        errorMessage.style.display = "block";
      }
    });
  </script>
</body>
</html>
